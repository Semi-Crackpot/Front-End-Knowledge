# 聚合管道

### 聚合管道的作用
1.  对集合中的数据进行变换和组合

### 聚合管道操作
1.  查询指定字段，并排序
    ```js
    db.order.aggregate([
        {
            // 查询 trade_no 字段和 all_price 字段的数据
            // 首先按 trade_no 字段进行升序排序
            // 再按 all_price 字段进行降序排序
            $project: { trade_no: 1, all_price: 1}
        }
    ])
2.  查询指定字段，并匹配条件
    ```js
    db.order.aggregate([
        {
            $project: { trade_no: 1, all_price: 1}
        },
        {
            // 匹配 all_price 字段的值大于等于90的数据
            $match: {'all_price': {$gte: 90}}
        }
    ])
3.  根据条件分组，并进行指定操作
    ```js
    db.order.aggregate([
        {
            // 根据 order_id 字段进行分组
            // 每组中，计算所有数据的 num 字符的和，并赋给 total 字段
            $group: {_id: '$order_id', total: {$sum: '$num'}}
        }
    ])
4.  排序
    ```js
    db.order.aggregate([
        {
            // 根据 all_price 字段进行降序排序
            $sort: {'all_price': -1}
        }
    ])
5.  限制查询条数
    ```js
    db.order.aggregate([
        {
            // 只查询一条数据
            $limit: 1
        }
    ])
6.  跳过若干条数据再进行查询
    ```js
    db.order.aggregate([
        {
            $sort: {'all_price': -1}
        },
        {
            // 跳过第一条数据，再进行查询
            $skip: 1
        }
    ])
7.  表关联：多个表之间进行关联
    ```js
    // 操作 order 表
    db.order.aggregate([
        {
            // 进行关联
            $lookup: 
            {
                // 关联 order_item 表
                from: 'order_item',
                // 本表（order表）的关联字段
                localField: 'order_id',
                // 外表（order_item表）的关联字段
                foreignField: 'order_id',
                // 将外表关联到的数据，统一放到数组里，赋给本表对应数据的 items 字段
                as: 'items'
            }
        }
    ])

### 