# 中间件

### 中间件的作用
1.  配置路由匹配时的一些操作

### 安装
1.  安装中间件：``nest g middleware middleware/init``，中间件放在src/middleware目录下，init是中间件名称
2.  在根模块``app.module.ts``中，配置中间件
    ```ts
    // 引入中间件
    import { InitMiddleware } from './middleware/init.middleware'
    // 使根模块 AppModule 继承 NestModule 接口
    export class AppModule implements NestModule{
        // 配置中间件，接收参数consumer，参数类型是MiddlewareConsumer
        configure(consumer: MiddlewareConsumer) {
            consumer
                // 配置使用哪个中间件
                .apply(InitMiddleware)
                // 配置中间件匹配哪个路由，此处匹配所有路由
                .forRoutes('*')
        }
    }

### 中间件文件解析
    ```ts
    // 引入 Injectable装饰器，NestMiddleware接口
    import { Injectable, NestMiddleware } from '@nestjs/common';
    @Injectable()
    export class InitMiddleware implements NestMiddleware {
        use(req: any, res: any, next: () => void) {
            // 定义路由匹配成功时的操作
            console.log(Date.now());
            // 完成匹配后，可以进行下一次路由匹配
            next();
        }
    }
    ```

### 匹配路由的多种写法
1.  匹配所有路由：``.forRoutes('*')``
2.  匹配 /user 路由：``.forRoutes('user')``
3.  只匹配采用GET方法的 /user路由：``.forRoutes({ path: 'user', method: RequestMethod.GET })``
4.  匹配多个路由：``.forRoutes({ path: 'user', method: RequestMethod.GET }, { path: 'news', method: RequestMethod.ALL })``
5.  配置多个中间件：
    ```ts
    consumer
      // InitMiddleware中间件，匹配所有路由
      .apply(InitMiddleware)
      .forRoutes('*')
      // UserMiddleware中间件，只匹配 /user路由
      .apply(UserMiddleware)
      .forRoutes('user')
6.  配置多个中间件同时匹配多个路由
    ```ts
    consumer
      .apply(InitMiddleware, UserMiddleware)
      .forRoutes('news', 'user')

### 函数式中间件
1.  创建函数式中间件的文件：``logger.middleware.ts``，logger是中间件的名称
2.  在文件中导出logger函数
    ```ts
    export  function logger(req, res, next) {
        console.log('函数中间件');
        next();
    }

### 全局中间件
1.  配置全局中间件时，``只能使用函数式中间件``
2.  在入口文件``main.ts``中，配置全局中间件
    ```ts
    // 引入函数式中间件
    import { logger } from './middleware/logger.middleware'
    // 配置为全局中间件，该中间件会对全局路由生效
    app.use(logger);

### 

