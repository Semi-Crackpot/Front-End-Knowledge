# 管道

### 管道的作用
1.  将输入数据转换成所需的输出
2.  验证数据，当数据不正确时，抛出异常

### 安装
- 安装管道：``nest g pipe pipe/news``，管道文件放在src/pipe目录下，news是管道的名称

### 管道文件解析
    ```ts
    // 引入ArgumentMetadata数据类型，Injectable装饰器，PipeTransform接口
    import { ArgumentMetadata, Injectable, PipeTransform } from '@nestjs/common';
    @Injectable()
    // 导出一个管道类
    export class NewsPipe implements PipeTransform {
        // 类中实现transform方法
        transform(value: any, metadata: ArgumentMetadata) {
            // value是路由的GET或POST传值
            return value;
        }
    }
    ```

### 修改路由的传值
1.  在控制器中设置路由时，使用管道
    ```ts
    @Get()
    // 使用管道NewsPipe
    @UsePipes(new NewsPipe())
    // 需要使用Query装饰器，来获取GET传值
    index(@Query() query): string {
        return '新闻页面'
    }
2.  在管道文件中，修改路由的传值
    ```ts
    @Injectable()
    export class NewsPipe implements PipeTransform {
        // value就是路由的传值，假设我们传值 ?name=zhangsan
        transform(value: any, metadata: ArgumentMetadata) {
            // 获取的传值是一个对象，所以通过value.name就能修改这个数据
            value.name = 'lisi';
            console.log(value); // { name: 'lisi' }
            return value;
        }
    }

### 验证路由的传值
1.  首先，路由的传值一般是通过表单提交得到的数据，因此``验证路由传值 == 验证用户填写的表单数据``
2.  安装``@hapi/joi``库：``cnpm i @hapi/joi --save``
3.  在管道文件中，配置数据的验证
    ```ts
    @Injectable()
    export class NewsPipe implements PipeTransform {
        // 定义私有属性schema
        private schema;
        // 定义构造函数，需要传入一个参数schema
        constructor(schema) {
            // 使私有属性的值，就等于传入的参数
            this.schema = schema;
        }
        transform(value: any, metadata: ArgumentMetadata) {
            // 使用传入的schema，对数据value进行验证
            const { error } = this.schema.validate(value);
            // 如果验证数据出错
            if(error) {
                // 打印false
                console.log(false);
                return false
            // 如果验证数据正确
            } else {
                // 打印数据
                console.log(value);
                return value;
            }
        }
    }
4.  在控制器中使用管道时，进行数据的验证
    ```ts
    // 引入@hapi/joi库
    import * as Joi from '@hapi/joi';
    // 定义用于数据验证的schema
    const userSchema = Joi.object().keys(
        { 
            // 对输入的name进行验证，必须是字符串，且必须输入
            name: Joi.string().required(), 
            // 对输入的age进行验证，必须是整数，且必须输入
            age: Joi.number().integer().min(6).max(66).required()
        }
    )
    @Controller('user')
    export class NewsController {
        @Get()
        // 在使用管道时，传入参数，即定义好的userSchema
        @UsePipes(new NewsPipe(userSchema))
        index(@Query() query): string {
            return '新闻页面'
        }
    }

### 