# 浏览器缓存：https://segmentfault.com/a/1190000008377508

### 浏览器缓存的分类
1.  强制缓存
2.  协商缓存

### 强制缓存相关字段
1.  HTTP1.1 使用 Cache-Control，以下是 Cache-Control 的内容
  - max-age：设置缓存最大的有效时间，单位是秒
  - s-maxage：同 max-age，但只能用于共享缓存（比如 CDN 缓存）
  - public：缓存可以在多用户之间共享
  - private：缓存是私有的，不能在用户之间共享
  - no-cache：资源不进行缓存
    - 并不代表浏览器不缓存，而是在缓存前要向服务器确认资源是否被更改
    - 只设置 no-cache 防止缓存不够保险，还可以加上 private，并将过期时间设置为过去的时间
  - no-store：绝对禁止缓存
2.  HTTP1.0 使用 Expires
  - 含义：缓存过期时间
  - 值：服务器端的具体的时间点，也就是说，Expires = max-age + 请求时间
  - 缺点：服务器的时间和浏览器的时间可能并不一致，所以 HTTP1.1 提出 Cache-Control 来代替它
3.  优先级
  - Cache-Control(s-maxage > max-age) > Expires

### 协商缓存相关字段
- 字段分为两种，它们不同时出现
1.  Last-Modified：服务器端文件的最后修改时间，需要和 Cache-Control 共同使用
  - 值：具体时间
  - 当浏览器再次请求时，如果资源过期（使用 Cache-Control 的 max-age 字段），会向服务器发送 If-Modified-Since 报头，询问 Last-modified 时间点后资源是否被修改过
  - 如果没有修改，则状态码返回 304，继续使用缓存；如果修改过，则去服务器请求资源，状态码返回 200
2.  ETag：根据实体内容生成一段 hash 字符串，标识资源的状态，由服务端产生
  - 客户端请求页面，服务器返回页面和 ETag
  - 客户端再次请求页面，如果资源过期（使用 Cache-Control 的 max-age 字段），则向服务器请求时带上 If-None-Match （ETag 的值）报头
  - 服务器收到请求后，与被请求资源的相应校验串进行对比，决定返回 200 还是 304
3.  使用 ETag 可以解决 Last-Modified 存在的一些问题
  - 某些服务器不能精确得到资源的最后修改时间，这样就无法通过最后修改时间来判断资源是否更新
  - 如果资源修改非常频繁，在秒以下的时间内进行修改，而 Last-Modified 只能精确到秒
  - 一些资源的最后修改时间改变了，但内容没改变，使用 ETag 就认为资源是没有修改的

### 使用缓存的流程
1.  首先查看是否存在资源，若存在，进行步骤2；否则，向服务器发送请求
2.  判断缓存是否过期，若未过期，直接使用强制缓存；否则，进行步骤3
3.  判断 ETag 是否存在
  4.  若存在，向服务器发送 If-None-Match，服务器检查 ETag，决定返回 304 还是 200
    5.  如果返回 304，说明资源未被修改，则读取本地缓存
    6.  如果返回 200，则发送请求到服务器，请求响应，缓存协商
  7.  若不存在，判断 Last-Modified 是否存在
    8.  如果存在，向服务器请求 If-Modified-Since，询问 Last-modified 时间点后资源是否被修改过，服务器根据情况返回 304 或 200
      9.  如果返回 304，说明资源未被修改，则读取本地缓存
      10. 如果返回 200，则发送请求到服务器，请求响应，缓存协商
    11. 如果不存在，向服务器发送请求

### Cache-Control 指令的使用
1.  判断资源是否可以被重用，是的话，进行步骤2；否则，使用 no-store
2.  判断每次请求是否重新验证，否的话，进行步骤3；否则，使用 no-cache
3.  判断是否允许被代理服务缓存，是的话，使用 public；否则，使用 private
4.  判断最长的缓存时间，使用 max-age

### 浏览器缓存放在哪里
1.  打开浏览器网页时，浏览器会在 js 和图片等文件解析执行后直接存入`内存缓存`中，当刷新页面时，只需直接从内存缓存中读取(from memory cache)
2.  而 css 文件则会存入硬盘文件中，所以每次渲染页面（包括打开页面和刷新页面）都需要从硬盘读取缓存(from disk cache)